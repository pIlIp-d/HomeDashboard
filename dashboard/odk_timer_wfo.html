<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
	<title></title>

	<style type="text/css">
		html{
			font-family: Arial;
			display: inline-block;
			margin: 0px auto;
			text-align: center;
			background-color: white;
			align-self: center;
			justify-self: center;
			-moz-appearance: none;
			-webkit-appearance: none;
			appearance: none;
			border: none;
			color: #000000;
			font-size: 1.8rem;
			height: auto;
			width: auto;
			outline: none;
		}
		#header_text {
			position: absolute;
			top: calc(45% - 1.1em);
			left:  calc(50% - 1.5rem);
		}
		#time {
			position: absolute;
			top: 47%;
			left:  calc(50% - 2.6rem);	
		}
		.button{
			position: absolute;
			top: 10px;
			right: 15px;
			margin: 0;
			padding: 0;
			width: 1.0rem;
			height: 1.0rem;	
		}
		#start{
			display:  block;
		}
		#stop{
			display:  none;
		}
		.time_select{
			-moz-appearance: none;
			-webkit-appearance: none;
			appearance: none;
			border: none;
			background: white;
			color: #000000;
			cursor: pointer;
			font-family: Arial;
			font-size: 1rem;
			width: auto;
			outline: none;
		}
		.dots{
			margin: 0;
			paddding: 0;
		}
	</style>
</head>
<body>
<!------------------------------------------------------------------------------
		Container Timer
------------------------------------------------------------------------------->
	<br>
	<div class="container unselectable"> 
		<area_header id="header_text">
			<span>Timer</span>
		</area_header>
		<area_button>
			<img src="/HomeDashboard/images/btn_start.svg" class="button" id="start" onclick="btn_start()">
			<img src="/HomeDashboard/images/btn_selected.svg" class="button" id="stop" onclick="btn_stop()">
		</area_button>
		<area_timer id="time">
			<select class="time_select" id="timer_hour"><option>00</option></select>
			<span class="dots">:</span>
			<select class="time_select" id="timer_minute"><option>00</option></select>
			<span class="dots">:</span>
			<select class="time_select" id="timer_second"><option>00</option></select>
		</area_timer>
	</div>
</body>
<script>
	const HOMESERVER_URL= "/HomeDashboard/";
	const DEVICE_ID = "001";
	const DEVICE_NAME = "Backofen";
	const INTERVALL_MAIN_TICKER = 1000;

	var INTERVALL_MAIN;
	var GUI_MODE = "[Viewer]";
	const BELL_CLOCK = document.getElementById("bell_clock");
	var TIMER_HOUR = document.getElementById("timer_hour");
	var TIMER_MINUTE = document.getElementById("timer_minute");
	var  TIMER_SECOND = document.getElementById("timer_second");
	const TIMER_CLOCK = document.getElementById("clock_1");
	const TIMER_START = document.getElementById("start");
	const TIMER_STOP = document.getElementById("stop");


	var ACT_HOUR;
	var ACT_MINUTE;
	var ACT_SECOND;
	var START_HOUR;
	var START_MINUTE;
	var START_SECOND;
	var stopped = false;
//-------------------------------
//----- INIT --------------------
//-------------------------------
	document.addEventListener("DOMContentLoaded", init());

	function init(){
		set_options();
		INTERVALL_MAIN = setInterval(interval_main_tick, INTERVALL_MAIN_TICKER);
	}
	var count= 0;
	function interval_main_tick(){
		//request
		check_clock();
		
		//chose your timer
		if (stopped){
			count++;
			if (count>60){
				stopped=false;
			}
		}
		else {
			count = 0;
		}
	}

//-------------------------------
//------ Buttons ----------------
//-------------------------------

	function set_options(){
		var i_string;
		TIMER_HOUR.options = 0;
		TIMER_MINUTE.options = 0;
		TIMER_SECOND.options = 0;
		for (i = 0; i < 60; ++i) {
			i_string = i.toString();
			if (i<10){
				i_string = "0" + i_string;
			}
			if (i<24){
				TIMER_HOUR.options[TIMER_HOUR.options.length] = new Option(i_string);
			}
			TIMER_MINUTE.options[TIMER_MINUTE.options.length] = new Option(i_string);
			TIMER_SECOND.options[TIMER_SECOND.options.length] = new Option(i_string);	
		}
		TIMER_HOUR.value = "00";
		TIMER_MINUTE.value = "00";
		TIMER_SECOND.value = "00";
	}
	
	function btn_start(){
		if ((parseInt(TIMER_HOUR.value) == 0) && (parseInt(TIMER_MINUTE.value) == 0) && (parseInt(TIMER_SECOND.value) == 0)){
			alert("Bitte erst Timer setzen!");
			return;
		}
		// Startindex für nächsten Durchlauf merken
		START_HOUR = TIMER_HOUR.value;
		START_MINUTE = TIMER_MINUTE.value;
		START_SECOND = TIMER_SECOND.value;
		// Zeit bis zum Timer-Start berechnen
		var timerstart = new Date();
		srv_timerstop  = timerstart.getTime() + (parseInt(TIMER_HOUR.value) * 3600 + parseInt(TIMER_MINUTE.value) * 60 + parseInt(TIMER_SECOND.value)) * 1000;	
		// Timer-Ende per http-Request auf Server schreiben	
		xhttp_send("set_timer_wfo", srv_timerstop)
		TIMER_START.style.display = "none";
		TIMER_STOP.style.display = "block";
		// Button "Stop" erst aktivieren wenn sich Sekundenanzeige geändert hat (Server hat reagiert)
		STOP_BUTTON_REQUEST = parseInt(TIMER_SECOND.value);

	}
	function btn_stop(){
		// gemerkten Startindex wieder eintragen
		TIMER_HOUR.value = START_HOUR;
		TIMER_MINUTE.value = START_MINUTE;
		TIMER_SECOND.value = START_SECOND;
		TIMER_START.style.display = "block";
		TIMER_STOP.style.display = "none";
		xhttp_send("del_timer_wfo", false)
	}

	function xhttp_send(event, value){
		var json_string = "{"
		json_string += "\"device_id\":\"" + DEVICE_ID + "\",";	
		json_string += "\"device_name\":\"" + DEVICE_NAME + "\",";
		json_string += "\"event\":\"" + event + "\"";
		if (event == "set_timer_wfo"){
			json_string += ",\"timer_stop_wfo\":\"" + value + "\"";
		}
		json_string += "}";
		var xhttp = new XMLHttpRequest();
		xhttp.open("GET",HOMESERVER_URL + "json_handler.php?json=" + json_string, true);
		xhttp.send();
	}
		
	
//-------------------------------
//------ Session Handling -------
//-------------------------------
	function gui_mode(){
		//vorerst weggelassen
	}

	function cookie_write(name, value){
		var a = new Date();
		a = new Date(a.getTime() + 1000 * 60 * 60 * 24 * 365);
		document.cookie = name + "=" + value + "; expires=" + a.toGMTString() + ";";
	}

	function cookie_read(name){
		a = document.cookie;
		res = "";
		while(a != ""){
			while(a.substr(0,1) == " "){
				a = a.substr(1, a.length);
			}
			cookiename = a.substring(0,a.indexOf("="));
			if(a.indexOf(";") != -1){
				cookiewert = a.substring(a.indexOf("=")+1, a.indexOf(";"));
			}
			else{
				cookiewert = a.substr(a.indexOf("=")+1, a.length);
			}
			if(name == cookiename){
				res = cookiewert;
			}
			i = a.indexOf(";")+1;
			if(i == 0){
				i = a.length
			}
			a = a.substring(i,a.length);
		}
		return(res);
	}

//---------------------------------------
//------- Request ----------------------- 
//---------------------------------------

	function check_clock(){
		var xhttp = new XMLHttpRequest();
		var json_string = "{\"device_id\":\""+DEVICE_ID+"\"";
		json_string += ",\"device_name\":\""+DEVICE_NAME+"\"";
		json_string += ",\"event\":\"get_allvalues\"";
		json_string += ",\"timeout\":\"30\"}";

		xhttp.onreadystatechange = function(){
			if (this.readyState == 4 && this.status == 200) {
			    json_response = this.responseText;
					handleHTTPresponse(json_response);
		    }
		}
		xhttp.open("GET", HOMESERVER_URL + "json_handler.php?json="+json_string,true);
		xhttp.send();
	}

	function handleHTTPresponse(json_response){
		var timestop = JSON.parse(json_response).timer_stop_wfo;
		var timenow = new Date();
		timenow = parseInt(timenow.getTime());
		var diff = Math.round((timestop - timenow) / 1000);

		//rest t > 0 
		if (diff > 0){
			//Timer-Uhr setzten
			ACT_HOUR = parseInt((diff / 3600) % 24);
			ACT_MINUTE = parseInt((diff / 60) % 60);
			ACT_SECOND = parseInt(diff % 60);
			//werte zweistellig machen
			if (ACT_HOUR < 10){
				var h_string = "0" + ACT_HOUR.toString();
			}
			else{
				var h_string = ACT_HOUR.toString();
			}
			if (ACT_MINUTE < 10){
				var m_string = "0" + ACT_MINUTE.toString();
			}
			else{
				var m_string = ACT_MINUTE.toString();
			}
			if (ACT_SECOND < 10){
				var s_string = "0" + ACT_SECOND.toString();
			}
			else{
				var s_string = ACT_SECOND.toString();
			}		
			// Werte anzeigen
			TIMER_HOUR.value = h_string;
			TIMER_MINUTE.value = m_string;
			TIMER_SECOND.value = s_string;
		}		
	}

</script>
</html>
